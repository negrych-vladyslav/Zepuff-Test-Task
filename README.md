#Zepuff-Test-Task
# üöÄ Node.js CI/CD –Ω–∞ GCP –∑ Ansible, Docker —Ç–∞ Certbot

–¶–µ–π –ø—Ä–æ—î–∫—Ç —Ä–µ–∞–ª—ñ–∑—É—î –Ω–∞–¥—ñ–π–Ω–∏–π, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–∏–π –ø—Ä–æ—Ü–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (CI/CD) –¥–ª—è Node.js –∑–∞—Å—Ç–æ—Å—É–Ω–∫—ñ–≤, —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏—Ö –Ω–∞ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω—ñ–π –º–∞—à–∏–Ω—ñ Google Cloud Platform (GCP).

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó: **Docker, Docker Compose, Ansible, Certbot (Let's Encrypt), Nginx, GitHub Actions, Ansible Vault.**

## üèóÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Ç–∞ –°–µ—Ä–µ–¥–æ–≤–∏—â–∞

–°–∏—Å—Ç–µ–º–∞ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞ –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –¥–≤–æ—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â –Ω–∞ –æ–¥–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—ñ, –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–∏—Ö –≥—ñ–ª–∫–∞–º–∏ Git:

|–°–µ—Ä–µ–¥–æ–≤–∏—â–µ|–ì—ñ–ª–∫–∞ Git|–î–æ–º–µ–Ω|–ó–∞—Ö–∏—Å—Ç —Ç–∞ Health Check|
|---|---|---|---|
|**Production**|`main`|`prod.zepuff-test-task.pp.ua`|**HTTPS, –í–∞–ª—ñ–¥–Ω–∏–π –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç, Basic Auth**|
|**Development**|`dev`|`dev.zepuff-test-task.pp.ua`|HTTPS (–Ü–≥–Ω–æ—Ä—É—î —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç)|

### –õ–æ–≥—ñ–∫–∞ CI/CD

1. **–¢—Ä–∏–≥–µ—Ä:** `git push` —É –≥—ñ–ª–∫–∏ `main` –∞–±–æ `dev` –∑–∞–ø—É—Å–∫–∞—î GitHub Actions.
    
2. **–ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è:** GitHub Actions –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **SSH-–∫–ª—é—á** (`SSH_PRIVATE_KEY`) —Ç–∞ **Ansible Vault** –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ VM —ñ —Å–µ–∫—Ä–µ—Ç—ñ–≤.
    
3. **–î–µ–ø–ª–æ–π:** –°–∫—Ä–∏–ø—Ç **`deploy.sh`** –≤–∏–∫–ª–∏–∫–∞—î Ansible, –ø–µ—Ä–µ–¥–∞—é—á–∏ –∑–º—ñ–Ω–Ω—É `target_env` (`prod` –∞–±–æ `dev`).
    
4. **Health Check (–ö—Ä–∏—Ç–∏—á–Ω–æ):** –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—é `deploy.sh` –≤–∏–∫–æ–Ω—É—î –ø–µ—Ä–µ–≤—ñ—Ä–∫—É:
    
    - **Prod (`main`):** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `curl` –∑ –ø—Ä–∞–ø–æ—Ä–æ–º `--fail` –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ **–í–∞–ª—ñ–¥–Ω–æ—Å—Ç—ñ –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞**, **HTTPS-–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ** —Ç–∞ **Basic Authentication** –æ–¥–Ω–æ—á–∞—Å–Ω–æ.
        

## ‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ü–µ—Ä–µ–¥—É–º–æ–≤ —Ç–∞ –°–µ–∫—Ä–µ—Ç—ñ–≤

### 1. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SSH –¥–ª—è CI/CD

–î–ª—è –±–µ–∑–ø–∞—Ä–æ–ª—å–Ω–æ—ó –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó Ansible:

1. **–ó–≥–µ–Ω–µ—Ä—É–π—Ç–µ** –ø–∞—Ä—É SSH-–∫–ª—é—á—ñ–≤ **–±–µ–∑ –ø–∞—Ä–æ–ª—å–Ω–æ—ó —Ñ—Ä–∞–∑–∏** (passphrase):
    
    ```
    ssh-keygen -t rsa -b 4096 -f ci_key
    ```
    
2. –î–æ–¥–∞–π—Ç–µ –≤–º—ñ—Å—Ç –ø—É–±–ª—ñ—á–Ω–æ–≥–æ –∫–ª—é—á–∞ (`ci_key.pub`) –¥–æ **Metadata SSH** –≤–∞—à–æ—ó VM –≤ Google Cloud Console.
    
3. –û–Ω–æ–≤—ñ—Ç—å `ansible/inventory`, –≤–∫–∞–∑–∞–≤—à–∏ —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —Å—Ç–≤–æ—Ä–µ–Ω–µ GCP.
    

### 2. GitHub Secrets (–û–±–æ–≤'—è–∑–∫–æ–≤–æ)

–£—Å—ñ —á—É—Ç–ª–∏–≤—ñ –¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ **GitHub Secrets** (Settings > Secrets > Actions):

|–ù–∞–∑–≤–∞ –°–µ–∫—Ä–µ—Ç—É|–§–æ—Ä–º–∞—Ç|–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è|
|---|---|---|
|**`SSH_PRIVATE_KEY`**|–í–º—ñ—Å—Ç —Ñ–∞–π–ª—É `ci_key`|–ü—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á –¥–ª—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó.|
|**`ANSIBLE_VAULT_PASSWORD`**|–¢–µ–∫—Å—Ç|–ü–∞—Ä–æ–ª—å –¥–ª—è —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è `vault.yml`.|
|**`PROD_BASIC_AUTH`**|`user:password`|–û–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –¥–ª—è Health Check Prod (–ù–∞–ø—Ä–∏–∫–ª–∞–¥, `admin:mysecret`).|

### 3. –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Ansible –¥–ª—è CI/CD

–§–∞–π–ª **`ansible.cfg`** –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ —Ä–æ–∑–º—ñ—â–µ–Ω–∏–π —É –∫–æ—Ä–µ–Ω—ñ –ø—Ä–æ—î–∫—Ç—É, —â–æ–± –≤–∏–º–∫–Ω—É—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –∫–ª—é—á—ñ–≤ —Ö–æ—Å—Ç–∞ (—â–æ —î –ø—Ä–∏—á–∏–Ω–æ—é –ø–æ–º–∏–ª–∫–∏ `Host key verification failed` —É CI-—Ä–∞–Ω–Ω–µ—Ä–∞—Ö).

```
[defaults]
host_key_checking = False
inventory = ./ansible/inventory
vault_password_file = .vault_pass
```

## üìÑ –û—Å–Ω–æ–≤–Ω—ñ –§–∞–π–ª–∏ –ü—Ä–æ—î–∫—Ç—É

### `deploy.sh`

–Ñ–¥–∏–Ω–∞ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥—É, —è–∫–∞ –∫–µ—Ä—É—î –¥–µ–ø–ª–æ—î–º —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞–º–∏.

**–õ–æ–∫–∞–ª—å–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è:**

–î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è Prod-—Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ:

```
# –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–º—ñ–Ω–Ω—É –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
export BASIC_AUTH_CREDENTIALS="myuser:mypassword"

# –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—é
bash deploy.sh main ~/.vault_pass.txt
```

### `.github/workflows/main.yml`

–§–∞–π–ª –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó CI/CD. –í—Å—Ç–∞–Ω–æ–≤–ª—é—î SSH-–∫–ª—é—á —Ç–∞ –∑–º—ñ–Ω–Ω—ñ –æ—Ç–æ—á–µ–Ω–Ω—è, –≤–∫–ª—é—á–Ω–æ –∑ **ANSIBLE_HOST_KEY_CHECKING: 'false'** –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—ó —Ä–æ–±–æ—Ç–∏.

## ‚ö†Ô∏è –£—Å—É–Ω–µ–Ω–Ω—è –ù–µ—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π (Troubleshooting)

| –ü–æ–º–∏–ª–∫–∞ / –ü—Ä–æ–±–ª–µ–º–∞                    | –ü—Ä–∏—á–∏–Ω–∞                                             | –†—ñ—à–µ–Ω–Ω—è                                                                                                                                                    |
| ------------------------------------- | --------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`Host key verification failed`**    | Ansible –Ω–µ –≤–∏–º–∫–Ω—É–≤ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –∫–ª—é—á—ñ–≤ —Ö–æ—Å—Ç–∞.          | –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ñ–∞–π–ª `ansible.cfg` —î —É –∫–æ—Ä–µ–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é –ê–ë–û —â–æ –∑–º—ñ–Ω–Ω–∞ `ANSIBLE_HOST_KEY_CHECKING: 'false'` –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —É `.github/workflows/main.yml`. |
| **`UNREACHABLE!`** (Ansible)          | –ü—Ä–æ–±–ª–µ–º–∞ –∑ SSH-–∫–ª—é—á–µ–º –∞–±–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º.             | –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –∫–æ—Ä–µ–∫—Ç–Ω–æ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ `SSH_PRIVATE_KEY` —É —Å–µ–∫—Ä–µ—Ç–∏ —Ç–∞ —á–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–∫–∞–∑–∞–Ω–æ `ansible_user` –≤ `inventory`.                                       |
| **`curl` –ø–æ–≤–µ—Ä—Ç–∞—î –ö–æ–¥ 22** (Prod)     | –ó–±—ñ–π Health Check, –∑–∞–∑–≤–∏—á–∞–π —á–µ—Ä–µ–∑ 401 Unauthorized. | –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ —Å–µ–∫—Ä–µ—Ç `PROD_BASIC_AUTH` –∫–æ—Ä–µ–∫—Ç–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π —É GitHub Secrets.                                                                             |
| **`'branch' is undefined`** (Ansible) | –£ Playbook –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Å—Ç–∞—Ä–∞ –∑–º—ñ–Ω–Ω–∞.           | –û–Ω–æ–≤—ñ—Ç—å `ansible/playbook.yml`: –∑–∞–º—ñ–Ω—ñ—Ç—å —É—Å—ñ `branch` –Ω–∞ `target_env`.                                                                                     |


'branch' is undefined (Ansible)

–£ Playbook –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Å—Ç–∞—Ä–∞ –∑–º—ñ–Ω–Ω–∞.

–û–Ω–æ–≤—ñ—Ç—å ansible/playbook.yml: –∑–∞–º—ñ–Ω—ñ—Ç—å —É—Å—ñ branch –Ω–∞ target_env.
